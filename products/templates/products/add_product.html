{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block content %}
<div class="container mt-5 add-product-container">
    <div class="row justify-content-center" style="margin-top: 6rem;">
        <div class="col-12 col-lg-8">
            <hr class="bg-secondary">
            <h2 class="logo-font mb-4 text-center">Product Management</h2>
            <h5 class="text-muted text-center">Add a Product</h5>
            <hr class="bg-secondary">
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <form method="POST" action="{% url 'add_product' %}" class="form p-4 shadow rounded bg-light" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Image Display Section -->
                <div class="col-12 col-md-6 col-lg-4 offset-lg-2">
                    <div class="image-container my-5">
                        {% if product.image %}
                            <a href="{{ product.image.url }}" target="_blank">
                                <img class="card-img-top img-fluid" src="{{ product.image.url }}" alt="{{ product.name }}">
                            </a>
                        {% else %}
                            <a href="{{ MEDIA_URL }}noimage.webp" target="_blank">
                                <img class="card-img-top img-fluid" src="{{ MEDIA_URL }}noimage.webp" alt="{{ product.name }}">
                            </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Main Category Selection -->
                <div id="div_id_category" class="form-group mb-3">
                    <label for="id_category" class="form-label fw-bold">Category</label>
                    <select name="category" id="id_category" class="border-black rounded-0 select form-select">
                        <option value="1">Drones</option>
                        <option value="2">Accessories</option>
                        <option value="3">Carry Cases</option>
                        <option value="4">Remotes</option>
                        <option value="5">Battery Packs</option>
                        <option value="6">Propellors and Blades</option>
                        <option value="7">Cameras</option>
                        <option value="8">Lenses</option>
                        <option value="9">VR Goggles</option>
                        <option value="10">Drone Spare Parts</option>
                        <option value="11">Bundles</option>
                        <option value="12">New Arrivals</option>
                        <option value="13">Deals</option>
                        <option value="14">Custom Drones</option>
                    </select>
                </div>

                <!-- Subcategory for "New Arrivals" and "Deals" -->
                <div id="div_id_subcategory" class="form-group mb-3" style="display: none;">
                    <label for="id_subcategory" class="form-label fw-bold">Subcategory</label>
                    <select name="subcategory" id="id_subcategory" class="border-black rounded-0 select form-select">
                        <option value="">Select a subcategory</option>
                        <option value="1">Drones</option>
                        <option value="2">Accessories</option>
                        <option value="3">Carry Cases</option>
                        <option value="4">Remotes</option>
                        <option value="5">Battery Packs</option>
                        <option value="6">Propellors and Blades</option>
                        <option value="7">Cameras</option>
                        <option value="8">Lenses</option>
                        <option value="9">VR Goggles</option>
                        <option value="10">Drone Spare Parts</option>
                        <option value="11">Bundles</option>
                        <option value="14">Custom Drones</option>
                    </select>
                </div>

                <!-- General Fields -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_sku" class="form-group mb-3">
                            <label for="id_sku" class="form-label fw-bold">SKU</label>
                            <input type="text" name="sku" id="id_sku" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_name" class="form-group mb-3">
                            <label for="id_name" class="form-label fw-bold">Name<span class="asteriskField text-danger">*</span></label>
                            <input type="text" name="name" id="id_name" class="border-black rounded-0 textinput form-control" required>
                        </div>
                    </div>
                </div>

                <div id="div_id_description" class="form-group mb-3">
                    <label for="id_description" class="form-label fw-bold">Description<span class="asteriskField text-danger">*</span></label>
                    <textarea name="description" id="id_description" class="border-black rounded-0 textarea form-control" required></textarea>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_price" class="form-group mb-3">
                            <label for="id_price" class="form-label fw-bold">Price<span class="asteriskField text-danger">*</span></label>
                            <input type="number" name="price" id="id_price" class="border-black rounded-0 numberinput form-control" step="0.01" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_image" class="form-group mb-3">
                            <label for="id_image" class="form-label fw-bold">Image</label>
                            <input type="file" name="image" id="id_image" class="border-black rounded-0 form-control">
                        </div>
                    </div>
                </div>

                <!-- Category-specific fields -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_color" class="form-group mb-3">
                            <label for="id_color" class="form-label fw-bold">Color</label>
                            <input type="text" name="color" id="id_color" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_rotors" class="form-group mb-3">
                            <label for="id_rotors" class="form-label fw-bold">Rotors</label>
                            <input type="number" name="rotors" id="id_rotors" class="border-black rounded-0 numberinput form-control">
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_speed" class="form-group mb-3">
                            <label for="id_speed" class="form-label fw-bold">Speed</label>
                            <input type="text" name="speed" id="id_speed" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_weight" class="form-group mb-3">
                            <label for="id_weight" class="form-label fw-bold">Weight</label>
                            <input type="text" name="weight" id="id_weight" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_flight_time" class="form-group mb-3">
                            <label for="id_flight_time" class="form-label fw-bold">Flight Time</label>
                            <input type="text" name="flight_time" id="id_flight_time" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_camera" class="form-group mb-3">
                            <label for="id_camera" class="form-label fw-bold">Camera</label>
                            <select name="camera" id="id_camera" class="border-black rounded-0 select form-select">
                                <option value="" selected>---------</option>
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_camera_quality" class="form-group mb-3">
                            <label for="id_camera_quality" class="form-label fw-bold">Camera Quality</label>
                            <input type="text" name="camera_quality" id="id_camera_quality" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_compatibility" class="form-group mb-3">
                            <label for="id_compatibility" class="form-label fw-bold">Compatibility</label>
                            <input type="text" name="compatibility" id="id_compatibility" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                </div>

                <div id="div_id_package_contents" class="form-group mb-3">
                    <label for="id_package_contents" class="form-label fw-bold">Package Contents</label>
                    <textarea name="package_contents" id="id_package_contents" class="border-black rounded-0 textarea form-control"></textarea>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_warranty" class="form-group mb-3">
                            <label for="id_warranty" class="form-label fw-bold">Warranty</label>
                            <input type="text" name="warranty" id="id_warranty" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_material" class="form-group mb-3">
                            <label for="id_material" class="form-label fw-bold">Material</label>
                            <input type="text" name="material" id="id_material" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_control_range" class="form-group mb-3">
                            <label for="id_control_range" class="form-label fw-bold">Control Range</label>
                            <input type="text" name="control_range" id="id_control_range" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_drones_included" class="form-group mb-3">
                            <label for="id_drones_included" class="form-label fw-bold">Drones Included</label>
                            <input type="number" name="drones_included" id="id_drones_included" class="border-black rounded-0 numberinput form-control">
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div id="div_id_drone_model" class="form-group mb-3">
                            <label for="id_drone_model" class="form-label fw-bold">Drone Model</label>
                            <input type="text" name="drone_model" id="id_drone_model" class="border-black rounded-0 textinput form-control">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="div_id_accessories_included" class="form-group mb-3">
                            <label for="id_accessories_included" class="form-label fw-bold">Accessories Included</label>
                            <textarea name="accessories_included" id="id_accessories_included" class="border-black rounded-0 textarea form-control"></textarea>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a class="btn btn-outline-secondary" href="{% url 'products' %}">Cancel</a>
                    <button class="btn btn-primary" type="submit">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block postloadjs %}
{{ block.super }}
<!-- JavaScript for Dynamic Display Logic -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('#id_category');
    const subcategorySelect = document.querySelector('#id_subcategory');
    const subcategoryDiv = document.querySelector('#div_id_subcategory');

    const categoryMap = {
        '1': 'Drones',
        '2': 'Accessories',
        '3': 'Carry Cases',
        '4': 'Remotes',
        '5': 'Battery Packs',
        '6': 'Propellors and Blades',
        '7': 'Cameras',
        '8': 'Lenses',
        '9': 'VR Goggles',
        '10': 'Drone Spare Parts',
        '11': 'Bundles',
        '12': 'New Arrivals',
        '13': 'Deals',
        '14': 'Custom Drones'
    };

    const fieldGroups = {
        'Drones': ['color', 'rotors', 'speed', 'weight', 'flight_time', 'camera', 'camera_quality', 'collision_avoidance', 'gps', 'control_range', 'max_altitude', 'wind_resistance', 'material', 'remote_control', 'mobile_app_support', 'warranty'],
        'Accessories': ['color', 'compatibility', 'material', 'package_contents', 'warranty'],
        'Carry Cases': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Remotes': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Battery Packs': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Propellors and Blades': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Cameras': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Lenses': ['compatibility', 'material', 'package_contents', 'warranty'],
        'VR Goggles': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Drone Spare Parts': ['compatibility', 'material', 'package_contents', 'warranty'],
        'Bundles': ['drones_included', 'drone_model', 'rotors', 'color', 'camera', 'camera_quality', 'flight_time', 'gps', 'control_range', 'accessories_included', 'compatibility', 'package_contents', 'warranty'],
        'Custom Drones': ['color', 'rotors', 'speed', 'weight', 'flight_time', 'camera', 'camera_quality', 'collision_avoidance', 'gps', 'control_range', 'max_altitude', 'wind_resistance', 'material', 'remote_control', 'mobile_app_support', 'warranty']
    };

    // Add Custom Drones Guidance Function
    function addCustomDronesGuidance() {
        // Remove any existing guidance
        document.querySelectorAll('.custom-drones-guidance').forEach(el => el.remove());
        document.querySelectorAll('.guidance-box').forEach(el => el.remove());

        if (categorySelect.value === '14') {
            // Add main guidance box after category selection
            const mainGuidance = document.createElement('div');
            mainGuidance.className = 'guidance-box custom-drones-guidance';
            mainGuidance.innerHTML = `
                <h6 class="fw-bold mb-3">Custom Drones Product Guidelines</h6>
                <p class="mb-2">Please follow these guidelines when adding a custom drone product:</p>
                <ul class="mb-0">
                    <li>Maintain consistent naming and SKU formats</li>
                    <li>Please ensure to add a different colored image for each drone color</li>
                    <li>Available colors: Black, White, Blue, Green, Pink, Purple, Red, Yellow, Orange</li>
                </ul>
            `;
            categorySelect.parentElement.appendChild(mainGuidance);
            mainGuidance.style.display = 'block';

            // Add field-specific guidance
            const fields = {
                'sku': {
                    element: document.querySelector('#div_id_sku'),
                    text: `Format: [product-name]-[next-sequential-number]-[color]<br>
                          Example: flying-orb-10004-green<br>
                          Next available number: 10005<br>
                          Available colors: black, white, blue, green, pink, purple, red, yellow, orange`
                },
                'name': {
                    element: document.querySelector('#div_id_name'),
                    text: `Format: [Product Name] - [Color]<br>
                          Example: Flying Orb - Green<br>
                          Separate multiple words with hyphens`
                },
                'image': {
                    element: document.querySelector('#div_id_image'),
                    text: `Filename format: [product-name]-[color].webp<br>
                          Example: flying-orb-green.webp<br>
                          Separate multiple words with hyphens`
                }
            };

            // Add guidance to each field
            for (const [fieldId, info] of Object.entries(fields)) {
                if (info.element) {
                    const guidance = document.createElement('small');
                    guidance.className = 'form-text text-muted custom-drones-guidance';
                    guidance.innerHTML = info.text;
                    info.element.appendChild(guidance);
                }
            }
        }
    }

    function toggleFields(selectedCategory, selectedSubcategory) {
        document.querySelectorAll('.form-group').forEach(field => field.classList.remove('show-field'));

        fieldGroups['Default'] = ['sku', 'name', 'description', 'price', 'image', 'category'];

        fieldGroups['Default'].forEach(fieldId => {
            document.querySelector(`#div_id_${fieldId}`).classList.add('show-field');
        });

        const fieldsToShow = selectedSubcategory ? fieldGroups[selectedSubcategory] : fieldGroups[selectedCategory];
        if (fieldsToShow) {
            fieldsToShow.forEach(fieldId => {
                const fieldElement = document.querySelector(`#div_id_${fieldId}`);
                if (fieldElement) {
                    fieldElement.classList.add('show-field');
                }
            });
        }
    }

    function updateFormFields() {
        const selectedCategory = categoryMap[categorySelect.value];
        const selectedSubcategory = subcategorySelect.value ? categoryMap[subcategorySelect.value] : null;

        if (selectedCategory === 'New Arrivals' || selectedCategory === 'Deals') {
            subcategoryDiv.style.display = 'block';
        } else {
            subcategoryDiv.style.display = 'none';
        }

        toggleFields(selectedCategory, selectedSubcategory);
        addCustomDronesGuidance();
    }

    categorySelect.addEventListener('change', updateFormFields);
    subcategorySelect.addEventListener('change', updateFormFields);
    updateFormFields();

    
});
</script>
{% endblock %}
